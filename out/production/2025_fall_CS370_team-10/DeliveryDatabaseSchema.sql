-- MySQL Script generated by MySQL Workbench (Complete & Fixed)
-- Target Database: mydb

SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0;
SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0;
SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION';

-- -----------------------------------------------------
-- Schema mydb
-- -----------------------------------------------------
CREATE SCHEMA IF NOT EXISTS `mydb` DEFAULT CHARACTER SET utf8 ;
USE `mydb` ;

-- -----------------------------------------------------
-- Table `mydb`.`userAccount`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `mydb`.`userAccount` (
  `userID` INT NOT NULL AUTO_INCREMENT,
  `userName` VARCHAR(45) NOT NULL UNIQUE,
  `password` VARCHAR(255) NOT NULL,
  `emailAddress` VARCHAR(100) NULL,
  `authorization` VARCHAR(45) DEFAULT 'user',  -- Authorization level: 'admin' or 'user'. Admin can see data flow info.
  PRIMARY KEY (`userID`))
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mydb`.`JobsTable`
-- Represents a specific work shift
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `mydb`.`JobsTable` (
  `jobsId` INT NOT NULL AUTO_INCREMENT,
  `userId` INT NOT NULL,
  `startTime` BIGINT NULL, 
  `endTime` BIGINT NULL,   
  `vehicle` VARCHAR(45) NULL,
  `totalEarnings` FLOAT DEFAULT 0.0,
  PRIMARY KEY (`jobsId`),
  INDEX `userId_idx` (`userId` ASC) VISIBLE,
  CONSTRAINT `userId_fk_jobs`
    FOREIGN KEY (`userId`)
    REFERENCES `mydb`.`userAccount` (`userID`)
    ON DELETE CASCADE
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mydb`.`deliveryData`
-- Represents individual deliveries
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `mydb`.`deliveryData` (
  `iddeliveryData` INT NOT NULL AUTO_INCREMENT,
  `toLocation` VARCHAR(100) NULL,
  `fromLocation` VARCHAR(100) NULL,
  `resturant` VARCHAR(100) NULL,
  `basePay` FLOAT DEFAULT 0.0,
  `tips` FLOAT DEFAULT 0.0,
  `extraExpenses` FLOAT DEFAULT 0.0,
  `platform` VARCHAR(45) NULL, 
  `totalTimeSpent` INT NULL, 
  `miles` INT DEFAULT 0,
  `timeSpentWaiting` INT DEFAULT 0, 
  `startTime` BIGINT NULL,  -- Epoch milliseconds when delivery started
  `endTime` BIGINT NULL,    -- Epoch milliseconds when delivery ended
  `jobsTableId` INT NOT NULL,
  PRIMARY KEY (`iddeliveryData`),
  INDEX `jobsTable_idx` (`jobsTableId` ASC) VISIBLE,
  CONSTRAINT `jobsTable_fk_delivery`
    FOREIGN KEY (`jobsTableId`)
    REFERENCES `mydb`.`JobsTable` (`jobsId`)
    ON DELETE CASCADE
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mydb`.`bankAccount`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `mydb`.`bankAccount` (
  `idbankAccount` INT NOT NULL AUTO_INCREMENT,
  `userId` INT NOT NULL,
  `accountType` VARCHAR(45) NULL, 
  `balance` DECIMAL(15, 2) DEFAULT 0.00,
  `interestRate` DECIMAL(5, 4) DEFAULT 0.0000,
  `accountFees` DECIMAL(10, 2) DEFAULT 0.00,
  `otherIncome` DECIMAL(15, 2) DEFAULT 0.00, -- Added field
  PRIMARY KEY (`idbankAccount`),
  INDEX `userID_bank_idx` (`userId` ASC) VISIBLE,
  CONSTRAINT `userID_fk_bank`
    FOREIGN KEY (`userId`)
    REFERENCES `mydb`.`userAccount` (`userID`)
    ON DELETE CASCADE
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mydb`.`expenses` (DEPRECATED - replaced by transaction table)
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `mydb`.`expenses` (
  `expenseId` INT NOT NULL AUTO_INCREMENT,
  `bankAccountID` INT NULL,
  `amount` DECIMAL(10, 2) NULL,
  `date` DATE NULL,
  `recurring` TINYINT NULL,
  `userId` INT NULL, 
  PRIMARY KEY (`expenseId`),
  INDEX `bankAccountID_idx` (`bankAccountID` ASC) VISIBLE,
  CONSTRAINT `bankAccountID_fk`
    FOREIGN KEY (`bankAccountID`)
    REFERENCES `mydb`.`bankAccount` (`idbankAccount`)
    ON DELETE SET NULL
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mydb`.`transaction`
-- Unified transaction table replacing expenses/income/transactions tables
-- transactionType must be one of: 'purchase', 'withdrawal', 'delivery income', 'other income'
-- 'purchase' and 'withdrawal' amounts should be negative
-- 'delivery income' and 'other income' amounts should be positive
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `mydb`.`transaction` (
  `transactionId` INT NOT NULL AUTO_INCREMENT,
  `userId` INT NOT NULL,
  `amount` DECIMAL(15, 2) NOT NULL,
  `transactionType` VARCHAR(20) NOT NULL CHECK (transactionType IN ('purchase', 'withdrawal', 'delivery income', 'other income')),
  `transactionDate` DATE NULL,
  `description` VARCHAR(255) NULL,
  `bankAccountId` INT NULL,
  PRIMARY KEY (`transactionId`),
  INDEX `transaction_user_idx` (`userId` ASC) VISIBLE,
  INDEX `transaction_type_idx` (`transactionType` ASC) VISIBLE,
  CONSTRAINT `fk_transaction_user`
    FOREIGN KEY (`userId`)
    REFERENCES `mydb`.`userAccount` (`userID`)
    ON DELETE CASCADE
    ON UPDATE NO ACTION,
  CONSTRAINT `fk_transaction_bank`
    FOREIGN KEY (`bankAccountId`)
    REFERENCES `mydb`.`bankAccount` (`idbankAccount`)
    ON DELETE SET NULL
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mydb`.`netValue`
-- Snapshots of a user's financial health at a point in time
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `mydb`.`netValue` (
  `idNetValue` INT NOT NULL AUTO_INCREMENT,
  `userId` INT NOT NULL,
  `totalAssets` DECIMAL(15, 2) DEFAULT 0.00,   -- Sum of positive bank balances
  `totalLiabilities` DECIMAL(15, 2) DEFAULT 0.00, -- Sum of debts/expenses
  `netWorth` DECIMAL(15, 2) DEFAULT 0.00,      -- Assets - Liabilities
  `snapshotDate` DATE NULL,                    -- When this was calculated
  PRIMARY KEY (`idNetValue`),
  INDEX `netValue_user_idx` (`userId` ASC) VISIBLE,
  CONSTRAINT `fk_netValue_user`
    FOREIGN KEY (`userId`)
    REFERENCES `mydb`.`userAccount` (`userID`)
    ON DELETE CASCADE
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mydb`.`platform` (Optional Dictionary)
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `mydb`.`platform` (
  `platformId` INT NOT NULL AUTO_INCREMENT,
  `platformName` VARCHAR(45) NULL,
  PRIMARY KEY (`platformId`))
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `mydb`.`vehicle` (Optional Dictionary)
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `mydb`.`vehicle` (
  `vehicleID` INT NOT NULL AUTO_INCREMENT,
  `vehicleType` VARCHAR(45) NULL,
  `vehicleModel` VARCHAR(45) NULL,
  `currentVehicleDriven` VARCHAR(10) DEFAULT 'false',
  `currentVehicleMiles` INT DEFAULT 0,
  `mpg` DOUBLE NULL,
  `startingMiles` INT DEFAULT 0,           -- Odometer reading when vehicle was acquired
  `purchacePrice` DOUBLE DEFAULT 15000.0,  -- Purchase price for depreciation calculations (required when adding new vehicle)
  PRIMARY KEY (`vehicleID`))
ENGINE = InnoDB;


SET SQL_MODE=@OLD_SQL_MODE;
SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS;
SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS;
